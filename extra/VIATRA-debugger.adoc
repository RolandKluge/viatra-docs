= VIATRA Debugger
ifdef::env-github,env-browser[:outfilesuffix: .adoc]
ifndef::rootdir[:rootdir: ../]
ifndef::source-highlighter[:source-highlighter: highlightjs]
ifndef::highlightjsdir[:highlightjsdir: {rootdir}/highlight.js]
ifndef::highlightjs-theme[:highlightjs-theme: tomorrow]
:imagesdir: {rootdir}

== Debugging model transformations
The development and debugging of  model transformations is not a trivial exercise, the basic concepts of software debugging however can be mapped to this field as well. Debuggers can be used for detecting bugs, as well as better understanding the structure and behavior of programs. Direct control over a program allows the programmer to follow the flow of execution or stop the program at any desired point. Then it is possible to inspect its current state and verify the correctness of the software. These properties are very desirable in the field of model transformations too.
The VIATRA framework possesses a debugger framework that supports the following features:

* Display the state of VIATRA transformations running in the SAME Eclipse instance as the debugger.
* Allow the user to control the execution of VIATRA transformations, via selecting the next activation to be executed.
* Display the model instances used in the transformation.
* Allow the user to define various transformation breakpoints.


== Architectural Overview
A full featured transformation debugger requires a software solution that is able to observe and control model transformations. Such an extension is able to insert additional functionality into certain points during model transformations. The transformation adapter framework allows the definition of additional functionalities that are executed at certain points in event-driven model transformations. The previously described debug functionalities are implemented using the transformation adapter framework.

.Adapter Framework
image::extra/images/adapter_framework.png[Adapter Framework]

* _Adapter Interface_: The Adapter Interface defines a set of callback methods that are executed at certain points during the transformation execution. These actions are capable of altering the execution sequence of transformation rules. A number of Adapters can implement this interface, in order to define additional functionality that should be undertaken at certain points in the transformation.
* _Listener Interface_: The Listener Interface defines a set of callback methods that are executed at certain points during the transformation execution. The actions defined in these methods can have no effect on the transformation itself, purely aim at providing a solution to listening to certain transformation-related events. A number of Adapters can implement this interface, in order to define additional functionality that should be undertaken at certain points in the transformation.
* _Adaptable EVM_: The Adaptable EVM is responsible aggregating the used Adapter and Listener instances and delegates the callback method calls from the internal VIATRA objects towards the appropriate callback method of each adapter or listener at certain points during execution. The Adaptable EVM is also responsible for setting up VIATRA transformation to utilize adapters.
* _Adapter Configuration_: The adapter configurations serve multiple purposes. They can either define dependency relations between adapter imple-mentations, or specify complex use cases which requires more than one adapter to func-tion properly

The Adapter Framework provides a generic, easy-to-use technique for creating user defined adapter and listener implementations. The Adapter Framework is utilized in order to implement a set of debugging-related use cases.

=== VIATRA Transformation Debugger
The VIATRA transformation debugger implements a breakpoint based debugging approach (similar to JDT). It utilizes the Eclipse Debug framework, as well as some custom debug-related views. It contains the logic for stopping the transformation execution if a breakpoint condition matches, and updating the Transformation Debug Model, based on which the current transformation state is displayed. To support various debugging use cases, the debugger supports various breakpoint implementations.

.Debug Adapter
image::extra/images/transformation_debugger.png[Debugger Overview]

* _Transformation Debugger_: Observes and manipulates the execution of a VIATRA transformation.
* _Transformation Debug Model_: Contains information about the transformation under debugging, and the attached breakpoints.
** _Transformation Context_: The context of a VIATRA transformation. This information is displayed by the debugger UI components.
*** _Transformation Rule Activations_: Rule activations that are being executed during the course of the transformation.
*** _Model Instances_: Source and target model instances that are involved in the transformation.
** _Breakpoints_: The debugger framework supports a set of different transformation breakpoints.
*** _Rule Activation Breakpoints_: Identifies a transformation rule activation. If the given activation is about to be fired, the transformation execution will be halted.
*** _Conditional Breakpoints_: These breakpoints are able to define global constraints that are not only affected by the current activation. A similar concept is available in the Eclipse Java Development Tools (JDT). The constraints are defined by using the VIATRA query language.
*** _Rule Breakpoints_: These breakpoints identify a given VIATRA transformation rule. The execution is halted if an activation of this rule is about to be fired.
* _VIATRA Debugger UI Elements_: The Transformation state is displayed via a set of debugging views.
** _VIATRA Adaptable Transformation Browser_: Displays the current state of the model transformation. Shows the set of activations to be fired, and allows the user to control the execution of the transformation or define breakpoints as well. The activations displayed can either be grouped by their parent rule, or their position in the transformation conflict set.
** _VIATRA Transformation Viewer_: Displays the current state of the model instances related to the transformation using a tree-view with properties support.
* _Transformation Debugger Configuration_: This configuration binds the transformation debug adapter and listener components together and allows a more straightforward usage.

=== User's Guide
The following section aims at providing a basic example of how the VIATRA transformation debugger should be used. The example utilizes the following VIATRA example projects:

* link:http://git.eclipse.org/c/viatra/org.eclipse.viatra.examples.git/tree/cps[VIATRA CPS Example]: The debugger example is based on the CPS meta-models, and utility features.
* link:http://git.eclipse.org/c/viatra/org.eclipse.viatra.examples.git/tree/transformation/transformation-debugger[VIATRA Transformation Debugger example]: Provides the example model transformations, and UI components responsible for running them.

==== Setting Up the Transformation Under Debugging
In order to support debugging the model transformation definition needs minor modifications. These can be done in two different ways:

* If the transformation is being newly developed, it is highly advised to use the VIATRA model transformation creation wizard. As shown on the figure below, the user can select the "VIATRA debugger support" checkbox, this way the generated code will incorporate the appropriate setup.

.Opening the Wizard
image::extra\screenshots\VIATRA_transformation_wizard_selection.png[Wizard selection]
.Selecting debugger support
image::extra\screenshots\VIATRA_transformation_wizard_debugging.png[Wizard debug]

* In case of an already-existing transformation, the model transformation definition needs to be modified manually. This involves adding the VIATRA debug configuration to the VIATRA transformation builder. The following example snippet shows how this is achieved in the example.

[[Transformation-setup]]
[source,Java]
----
private def createTransformation() {
    this.manipulation = new SimpleModelManipulations(engine)
    transformation = BatchTransformation.forEngine(engine).addAdapterConfiguration(new TransformationDebuggerConfiguration()).build
    statements = transformation.transformationStatements
}
----

As currently the debugger does not support inter-JVM communication, the transformation under debugging (TUD) needs to run in the same Eclipse instance as the debugger itself. In order to achieve this, the example uses a simple command and handler to run the model transformation on a predefined test model.

[[Transformation-handler]]
[source,Java]
----
public class BatchTestHandler extends AbstractHandler {
    @Override
    public Object execute(ExecutionEvent event) throws ExecutionException {
        final Job job = new Job("CPS batch job") {
            protected IStatus run(IProgressMonitor monitor) {
                // Load the CPS model
                CPSModelInitializer init = new CPSModelInitializer();
                CPSToDeployment cps2dep = init.loadModel("platform:/plugin/org.eclipse.viatra.examples.transformationdebugger/output/example.cyberphysicalsystem");
                // Initialize CPS to Deployment Transformation
                CPSTransformation transformation = new CPSBatchTransformation(cps2dep);
                // Execute the transformation and observe the effects of the selected adapter
                transformation.execute();
                transformation.dispose();
                return Status.OK_STATUS;
            }
        };
        job.schedule();
        return null;
    }
}
----

==== Using the Debugger UI

The following section describes how to use the VIATRA transformation debugger UI elements once debugging infrastructure is set up. This section of the guide assumes that a target Eclipse instance is running  that incorporates both the TUD and the debugger itself.

* If the VIATRA debugger feature is installed, the Debugger UI Elements are contained by the Eclipse Debug perspective, it should be selected and the related VIATRA debug views are displayed.

.Debug perspective with debugger views
image::extra\screenshots\VIATRA_debug_persp.png[Debug perspective]

* Once the transformation under debugging is started, it is displayed on the _Adaptable Transformation Browser_ view.

TODO...
